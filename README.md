# 気象庁の実測データを取得するスクリプト

このスクリプトでは気象庁のサイトから1時間ごとの値のページを解析して、データを取得します。

例）東京　東京、2020年1月1日<br>
https://www.data.jma.go.jp/obd/stats/etrn/view/hourly_s1.php?prec_no=44&block_no=47662&year=2020&month=1&day=1&view=

 <span style="color:red"> **注意**</span>：
このスクリプトでは、1日（24時間）分のデータごとにhtmlを取得しています。繰り返しサーバへリクエストを発行するため、サーバ側の負荷を考慮してインターバル（定数REQUEST_INTERVALで1秒）を設定しています。<br>
サーバの混雑状態などによりエラーが発生していると思われるときは、この値を長めにしてください。（逆に1秒未満はサーバの負荷が増えるので非推奨）

#### 処理時間の目安

1年分のデータを取得<br>
インターバル(1秒)+処理時間（0.1秒）として365日 ≓ 約7分の時間が掛かります。

### スクリプト

|ファイル|内容|
|-|-|
|get_amedas_progressbar.py|指定期間のデータを取得します。|


![実行画面](./images/Running%20image.png)


以下のリンク先の記事を参考にスクレイピングとTRNSYS用に値の変換を行っています。

[気象データを Python でスクレイピングする方法](https://www.gis-py.com/entry/scraping-weather-data?utm_source=pocket_mylist)


## 変更点
* 全天日射量をMJ/m2からW/m2へ換算
* 風向を文字（例：北北東）から角度（例：22.5）へ換算
* htmlの取得に失敗した際のエラー表示、停止処理
* 書き出し先のフォルダがない場合の作成処理
* 欠測値は基本的に <span style="color:red">**-9999**</span>として処理する
    * 未実測の値（"--"）は0へ変換
    * nullは0へ変換
    * それ以外の文字列を <span style="color:red">**-9999**</span>として扱う

### 方位の変換
方位表記と角度の対応表

|方位|値[deg]|
|-|-|
|北|0|
|北北東|22.5|
|北東|45|
|東北東|67.5|
|東|90|
|東南東|112.5|
|南東|135|
|南南東|157.5|
|南|180|
|南南西|202.5|
|南西|225|
|西南西|247.5|
|西|270|
|西北西|292.5|
|北西|315|
|北北西|337.5|
|静穏|0|


## セットアップ

### Python仮想環境の構築

プロジェクトごとに独立した環境を作成することを推奨します。

#### Windows

```bash
# 仮想環境の作成
python -m venv venv

# 仮想環境の有効化
venv\Scripts\activate

# 仮想環境の無効化（作業終了時）
deactivate
```
#### Mac,Linux
動作未確認。おそらく動作します。うまく動作しない場合も小規模な変更で対応できると思います。試してみてください。

### 必要なパッケージのインストール

仮想環境を有効化した状態で、以下のコマンドを実行します。

#### requirements.txtを使用する方法（推奨）

```bash
pip install -r requirements.txt
```

#### 個別にインストールする方法

```bash
pip install beautifulsoup4
pip install requests
pip install tqdm
```

#### インストールされたパッケージの確認

```bash
pip list
```

# 使用方法

### 地点情報の調べ方
取得したい地点のurlを確認するため、気象庁の「過去の気象データ検索」のサイトで地点を選択する

例）東京　東京、2020年1月1日<br>
http://www.data.jma.go.jp/obd/stats/etrn/index.php?prec_no=44&block_no=47662&year=2020&month=1&day=1&view=

ここで、"prec_no=44&block_no=47662"の部分が地点情報となる。

### スクリプトの実行

コマンドライン引数で地点情報（prec_no,block_no）と取得期間を指定して実行する。

#### 基本的な使用方法

```bash
python get_amedas_progressbar.py --prec_no <観測所番号> --block_no <ブロック番号> --start <開始日> --end <終了日>
```

#### 実行例

**東京（prec_no=44, block_no=47662）の2000年1月のデータを取得**
```bash
python get_amedas_progressbar.py --prec_no 44 --block_no 47662 --start 2000-01-01 --end 2000-01-31
```

**大阪（prec_no=62, block_no=47772）の2020年の1年分のデータを取得**
```bash
python get_amedas_progressbar.py --prec_no 62 --block_no 47772 --start 2020-01-01 --end 2020-12-31
```

**リクエスト間隔を2秒に設定（サーバー負荷を考慮）**
```bash
python get_amedas_progressbar.py --prec_no 44 --block_no 47662 --start 2000-01-01 --end 2000-01-31 --interval 2
```

#### パラメータ説明

| パラメータ | 必須 | 説明 | 例 |
|-----------|------|------|-----|
| --prec_no | ○ | 観測所番号 | 44 (東京) |
| --block_no | ○ | ブロック番号 | 47662 (東京) |
| --start | ○ | データ取得開始日（YYYY-MM-DD形式） | 2000-01-01 |
| --end | ○ | データ取得終了日（YYYY-MM-DD形式） | 2000-01-31 |
| --interval |  | サーバーへのリクエスト間隔（秒）。デフォルト: 1秒 | 2.0 |

#### ヘルプの表示

```bash
python get_amedas_progressbar.py --help
```

### 注意事項

 <span style="color:red"> **注意**</span>：実行のタイミングによって、うまくhtmlが取得できないケースが発生します。
その時は諦めて再実行してください。

1日単位で取得処理しているため途中で取得できなくなるケースもあり得ます。（たぶんサーバが忙しくてタイムアウトするとか、そういった理由）

1年を超える長期間のデータを取得するようなケースではリクエスト間隔(`--interval`)を長めに取る、時間帯を変えて再実行するなど工夫してください。


**リクエスト間隔について：**
- デフォルトは1秒に設定されています
- サーバーの負荷を考慮して、エラーが頻発する場合は `--interval` オプションで間隔を長く（例：2秒や3秒）してください
- 逆に1秒未満の設定はサーバーへの負荷が増えるため絶対に指定しないでください。

### 出力ファイル

データは `.\weather` フォルダに以下の形式で保存される：
```
{prec_no}_{block_no}_{開始年}_{終了年}_weather.csv
```

例：東京の2020年のデータの場合
```
44_47662_2020_2020_weather.csv
```


# 値の処理
値欄の記号と値の取り扱いは以下の通り。

|値欄|処理|
|-|-|
|空白|0|
|--|0|
|数値|そのまま数値|
|数値)|準正常値としてそのまま数値|
|それ以外|欠測として-9999|


## 参考
気象庁、値欄の記号の説明
https://www.data.jma.go.jp/obd/stats/data/mdrr/man/remark.html
